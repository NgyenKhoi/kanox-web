import React from "react";
import { Button, Spinner, Image } from "react-bootstrap";
import { FaCheckCircle, FaCircle, FaEllipsisH } from "react-icons/fa";
import useUserMedia from "../../hooks/useUserMedia";

function NotificationItem({ notification, handleMarkRead, handleMarkUnread }) {
  const {
    mediaUrl: avatarUrl,
    loading: mediaLoading,
    error: mediaError,
  } = useUserMedia(notification.targetId, "PROFILE", "image");

  const renderAvatar = () => {
    if (mediaLoading) {
      return <Spinner animation="border" size="sm" className="me-2 mt-1" />;
    }

    return (
      <Image
        src={avatarUrl || "https://placehold.co/40x40?text=Avatar"}
        roundedCircle
        className="me-2"
        style={{ width: "40px", height: "40px", objectFit: "cover" }}
        alt={`Avatar của ${notification.displayName}`}
      />
    );
  };

  return (
    <div
      className={`p-3 border-bottom ${
        !notification.isRead ? "bg-light-primary" : "opacity-75"
      }`}
    >
      <div className="d-flex align-items-start">
        {renderAvatar()}
        <div className="flex-grow-1">
          <div className="d-flex justify-content-between align-items-center">
            <p
              className="fw-bold mb-0 cursor-pointer text-primary"
              onClick={() =>
                handleMarkRead(notification.id, notification.displayName)
              }
            >
              {notification.displayName}
            </p>
            <div>
              {!notification.isRead ? (
                <Button
                  variant="link"
                  className="text-dark p-0 me-2"
                  onClick={() => handleMarkRead(notification.id)}
                >
                  <FaCheckCircle />
                </Button>
              ) : (
                <Button
                  variant="link"
                  className="text-dark p-0 me-2"
                  onClick={() => handleMarkUnread(notification.id)}
                >
                  <FaCircle />
                </Button>
              )}
              <Button variant="link" className="text-dark p-0">
                <FaEllipsisH />
              </Button>
            </div>
          </div>

          {/* Nội dung chính của thông báo */}
          <p className="mb-1">{notification.message}</p>

          {/* Hiển thị tag nếu có */}
          {notification.tags?.length > 0 && (
            <p className="text-primary small mb-1">
              {notification.tags.map((tag, idx) => (
                <span key={idx} className="me-1">
                  {tag}
                </span>
              ))}
            </p>
          )}

          {/* Nếu có ảnh trong nội dung notification */}
          {notification.image?.startsWith("http") && (
            <Image
              src={notification.image}
              fluid
              className="mt-2"
              style={{ maxWidth: "100%", height: "auto" }}
            />
          )}

          {/* Nếu là text mô tả AI (không phải ảnh) */}
          {notification.image?.startsWith("This image is generated by AI") && (
            <p className="text-muted small mt-2">{notification.image}</p>
          )}

          {/* Thời gian */}
          <p className="text-muted small mb-0">{notification.timestamp}</p>
        </div>
      </div>
    </div>
  );
}

export default NotificationItem;
